/**
 * tdesign v1.9.0
 * (c) 2024 tdesign
 * @license MIT
 */

import { ref, watch } from 'vue';
import { usePrefixClass } from '../../hooks/useConfig.mjs';
import { getNewMultipleValue } from '../helper.mjs';
import '../../config-provider/useConfig.mjs';
import '../../_chunks/dep-66473aa9.mjs';
import '../../_chunks/dep-cb814df4.mjs';
import '../../_chunks/dep-cd533155.mjs';
import '../../_chunks/dep-8dbc9855.mjs';
import '../../_chunks/dep-715774e0.mjs';
import '../../_chunks/dep-5a5a1764.mjs';
import '../../_chunks/dep-37e3e644.mjs';
import '../../_chunks/dep-31dc0415.mjs';
import '../../_chunks/dep-e5142249.mjs';
import '../../_chunks/dep-c4f80cb4.mjs';
import '../../_chunks/dep-996b4900.mjs';
import '../../_chunks/dep-3108c312.mjs';
import '../../_chunks/dep-93498383.mjs';
import '../../_chunks/dep-36582a92.mjs';
import '../../_chunks/dep-a2db6df1.mjs';
import '../../_chunks/dep-0f89a1dd.mjs';
import '../../_chunks/dep-2adf18a2.mjs';
import '../../_chunks/dep-ab439391.mjs';
import '../../_chunks/dep-60d62610.mjs';
import '../../_chunks/dep-d4da440a.mjs';
import '../../_chunks/dep-013382c3.mjs';
import '../../_chunks/dep-ca764006.mjs';
import '../../_chunks/dep-2ee9d497.mjs';
import '../../_chunks/dep-c545db54.mjs';
import '../../_chunks/dep-3f15cb30.mjs';
import '../../_chunks/dep-fd2b6c64.mjs';
import '../../_chunks/dep-30b3f256.mjs';
import '../../_chunks/dep-b3734774.mjs';
import '../../_chunks/dep-a4a3ac25.mjs';
import '../../_chunks/dep-6861d388.mjs';
import '../../_chunks/dep-396d852b.mjs';
import '../../_chunks/dep-8a3fd140.mjs';
import '../../_chunks/dep-5db0da5c.mjs';
import '../../_common/js/global-config/default-config.mjs';
import '../../_common/js/global-config/locale/zh_CN.mjs';
import '../../_chunks/dep-bf19d9ba.mjs';
import '../../_chunks/dep-6963a882.mjs';
import '../../config-provider/type.mjs';

function useKeyboardControl(_ref) {
  var displayOptions = _ref.displayOptions,
    optionsList = _ref.optionsList,
    innerPopupVisible = _ref.innerPopupVisible,
    setInnerPopupVisible = _ref.setInnerPopupVisible,
    selectPanelRef = _ref.selectPanelRef,
    isFilterable = _ref.isFilterable,
    getSelectedOptions = _ref.getSelectedOptions,
    setInnerValue = _ref.setInnerValue,
    innerValue = _ref.innerValue,
    popupContentRef = _ref.popupContentRef,
    multiple = _ref.multiple,
    max = _ref.max;
  var hoverIndex = ref(-1);
  var filteredOptions = ref([]);
  var virtualFilteredOptions = ref([]);
  var classPrefix = usePrefixClass();
  var handleKeyDown = function handleKeyDown(e) {
    var _optionsList$value$ne, _optionsList$value$ne2;
    var optionsListLength = displayOptions.value.length;
    var newIndex = hoverIndex.value;
    switch (e.code) {
      case "ArrowUp":
        e.preventDefault();
        if (hoverIndex.value === -1) {
          newIndex = 0;
        } else if (hoverIndex.value === 0 || hoverIndex.value > displayOptions.value.length - 1) {
          newIndex = optionsListLength - 1;
        } else {
          newIndex--;
        }
        if ((_optionsList$value$ne = optionsList.value[newIndex]) !== null && _optionsList$value$ne !== void 0 && _optionsList$value$ne.disabled) {
          newIndex--;
        }
        hoverIndex.value = newIndex;
        break;
      case "ArrowDown":
        e.preventDefault();
        if (hoverIndex.value === -1 || hoverIndex.value >= optionsListLength - 1) {
          newIndex = 0;
        } else {
          newIndex++;
        }
        if ((_optionsList$value$ne2 = optionsList.value[newIndex]) !== null && _optionsList$value$ne2 !== void 0 && _optionsList$value$ne2.disabled) {
          newIndex++;
        }
        hoverIndex.value = newIndex;
        break;
      case "Enter":
        if (hoverIndex.value === -1) break;
        var finalOptions = selectPanelRef.value.isVirtual && isFilterable.value && virtualFilteredOptions.value.length ? virtualFilteredOptions.value : filteredOptions.value;
        if (!finalOptions.length) finalOptions = optionsList.value;
        if (!innerPopupVisible.value) {
          setInnerPopupVisible(true, {
            e: e
          });
          break;
        }
        if (!multiple) {
          var selectedOptions = getSelectedOptions(finalOptions[hoverIndex.value].value);
          setInnerValue(finalOptions[hoverIndex.value].value, {
            option: selectedOptions === null || selectedOptions === void 0 ? void 0 : selectedOptions[0],
            selectedOptions: getSelectedOptions(finalOptions[hoverIndex.value].value),
            trigger: "check",
            e: e
          });
          setInnerPopupVisible(false, {
            e: e
          });
        } else {
          var _finalOptions$hoverIn;
          if (hoverIndex.value === -1) return;
          var optionValue = (_finalOptions$hoverIn = finalOptions[hoverIndex.value]) === null || _finalOptions$hoverIn === void 0 ? void 0 : _finalOptions$hoverIn.value;
          if (!optionValue) return;
          var newValue = getNewMultipleValue(innerValue.value, optionValue);
          if (max > 0 && newValue.value.length > max) return;
          var _selectedOptions = getSelectedOptions(newValue.value);
          setInnerValue(newValue.value, {
            option: _selectedOptions.find(function (v) {
              return v.value == optionValue;
            }),
            selectedOptions: _selectedOptions,
            trigger: newValue.isCheck ? "check" : "uncheck",
            e: e
          });
        }
        break;
      case "Escape":
        setInnerPopupVisible(false, {
          e: e
        });
        break;
    }
  };
  watch(innerPopupVisible, function (value) {
    if (value) {
      hoverIndex.value = -1;
      virtualFilteredOptions.value = [];
      filteredOptions.value = [];
    }
  });
  watch(hoverIndex, function (index) {
    var _selectPanelRef$value;
    var optionHeight = (_selectPanelRef$value = selectPanelRef.value) === null || _selectPanelRef$value === void 0 || (_selectPanelRef$value = _selectPanelRef$value.innerRef) === null || _selectPanelRef$value === void 0 ? void 0 : _selectPanelRef$value.querySelector(".".concat(classPrefix.value, "-select-option")).clientHeight;
    var scrollHeight = optionHeight * index;
    popupContentRef.value.scrollTo({
      top: scrollHeight,
      behavior: "smooth"
    });
  });
  return {
    hoverIndex: hoverIndex,
    handleKeyDown: handleKeyDown,
    virtualFilteredOptions: virtualFilteredOptions,
    filteredOptions: filteredOptions
  };
}

export { useKeyboardControl as default };
//# sourceMappingURL=useKeyboardControl.mjs.map
